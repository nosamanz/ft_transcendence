<!DOCTYPE html>
<html>
<head>
    <title>URL Query Parameter Example</title>
</head>
<body>

    <h2>URL Query Parameter Example</h2>
    <!-- <div id="CreateQR">
        <form>
            <button type="button" onclick="GenerateQR()">QRGenerate</button>
        </form>
    </div> -->
    <!-- <img id="image" src="" alt="Image">
    <script>
        const imageElement = document.getElementById('image');

        function GenerateQR()
        {
            // Fetch the image data from your backend API
            fetch('http://10.12.14.1:80/auth/tfa/enable') // Replace with the actual image ID
            .then(response => response.blob())
            .then(imageBlob => {
                const imageUrl = URL.createObjectURL(imageBlob);
                imageElement.src = imageUrl;
            })
            .catch(error => {
                console.error('Error fetching image:', error);
            });
        }
        fetch('http://10.12.14.1:80/auth/tfa/QR', {
                    headers: {
                    'authorization': 'Bearer ' + "merba",
                    'Content-Type': 'application/json'
                    },
                })
        .then(response => response.blob())
        .then(imageBlob => {
            const imageUrl = URL.createObjectURL(imageBlob);
            imageElement.src = imageUrl;
        })
        .catch(error => {
            console.error('Error fetching image:', error);
        });
    </script> -->

    <!-- <div id="tfaBLok">
        <form>
            <input id="tfaCode"></input>
            <button type="button">Gönder</button>
        </form>
    </div> -->

    <p id="result"></p>

  <script>
    window.onload = async function() {
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        var code = getQueryParam('code');

        if (code !== null) {
            document.getElementById("result").textContent = 'Code: ' + code;
            const data = {};
            data["data"] = code;

            try {
            const response = await fetch('http://10.12.14.1:80/auth/42/signin_intra', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                const responseData = await response.json(); 
                console.log("--------------------------------");
                console.log("Result: " + responseData.result);
                console.log("Token: " + responseData.token);
                console.log("UserID: " + responseData.user_id);
                console.log("ResponseData: " + responseData);
                console.log("--------------------------------");

                /* To get QR */
                // fetch('http://10.12.14.1:80/auth/tfa/QR', {
                //     headers: {
                //     'authorization': 'Bearer ' + responseData.token,
                //     'Content-Type': 'application/json'
                //     },
                // })
                // .then(response => response.blob())
                // .then(imageBlob => {
                //     const imageUrl = URL.createObjectURL(imageBlob);
                //     imageElement.src = imageUrl;
                // })
                // .catch(error => {
                //     console.error('Error fetching image:', error);
                // });

                    const responseUser = await fetch('http://10.12.14.1:80/user', {
                        headers: {
                        'authorization': 'Bearer ' + responseData.token,
                        'Content-Type': 'application/json'
                        },
                    });
                console.log(responseUser.ok);
                const responseUserData = await responseUser.json();
                console.log("Hoşgeldin "+ responseUserData.name + " by " + responseUserData.email);
                if(responseData == 2)
                {
                    // Code al
                }
                if(responseData == 1 || responseData == 0)
                {
                    // başarılı giriş
                }
                console.log('Server response:', responseData);
            } else {
                console.error('Failed to send data:', response.statusText);
            }
            } catch (error) {
            console.error('Error:', error);
            }

        } else {
            // "code" sorgu parametresi yoksa, uygun bir mesaj göster
            document.getElementById("result").textContent = 'Code not found in URL.';
        }

    };
  </script>
</body>
</html>
